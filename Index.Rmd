---
title: Amastra micans Niche Characterization
date: "`r Sys.Date()`"
author: Chandra Earl / Mia Leslie
output: (function(...) {
  rmdformats::robobook(toc_depth = 4, pandoc_args = c("+RTS", "-K2000m", "-RTS"), ...) })
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })  
---
  
 
# Load Libraries

```{r}
setwd("//CHANDRACLOUD/Data/Desktop_cloud/Labs/Yeung_Hayes/Stuff/For_Others/For_Mia")
project_crs <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
project_res <- c(0.00225, 0.00225)

library(hypervolume)
library(sf)
library(terra)
library(raster)
library(RColorBrewer)
library(dplyr)
library(ggplot2)
library(cowplot)
library(plotly)
library(htmlwidgets)
library(tools)

#distinctive colors for mapping
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector_random = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
col_vector_ordered <- colorRampPalette(c('blue', 'red'))
```

# Import Data

## Import Snail data
```{r}
#filenames
input_micans_filename <- "Data/Snail_data/micans.csv"
input_exclosures_filename <- "Data/Snail_data/oahu_exclosures.csv"

# Load the input data
snail_data <- read.csv(input_micans_filename, header = TRUE)
exclosure_data <- read.csv(input_exclosures_filename, header = TRUE)

#convert to sf object
snail_data_sf <- st_as_sf(snail_data, coords = c("decimalLongitude", "decimalLatitude"), crs = project_crs)
exclosure_data_sf <- st_as_sf(exclosure_data, coords = c("decimalLongitude", "decimalLatitude"), crs = project_crs)

#replace this to describe what island the snails are found - "bigisland", "lanai", "maui", "molokai", "kauai", "oahu", "koolau", "waianae"
snail_islands <- "oahu"
```


## Import Environmental Data

### Mountain shapefiles

#### Create mountain shapefiles
```{r include=FALSE}
#Read in elevation raster
#elevation <- raster("Data/Environmental_data/Elevation/Tif/LH20_Elev_220.tif")
#oahu_nad83 <- st_transform(oahu_shp, "+proj=aea +lat_0=13 +lon_0=-157 +lat_1=8 +lat_2=18 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs")
#elevation_cut <- crop(elevation, oahu_nad83)
#elevation_cut <- mask(elevation_cut, oahu_nad83)
#elevation_cut <- projectRaster(elevation_cut, crs=project_crs)

#Set a threshold, clip and convert
#elevation_threshold <- 300
#binary_mask <- elevation_cut > elevation_threshold
#binary_mask[binary_mask == 0] <- NA
#binary_mask <- rast(binary_mask)
#elevation_polygon <- as.polygons(binary_mask)

#waianaes
#extent_to_filter <- ext(-158.2608, -158.05, 21.28336, 21.66665)
#selected_polygons <- crop(elevation_polygon, extent_to_filter)
#plot(selected_polygons)
#shapefile_path <- "Data/Mountains_shapefile/Waianae.shp"
#writeVector(selected_polygons, shapefile_path, overwrite=TRUE)

#koolaus
#extent_to_filter <- ext(-158.05, -157.6748, 21.28336, 21.66665)
#selected_polygons <- crop(elevation_polygon, extent_to_filter)
#plot(selected_polygons)
#shapefile_path <- "Data/Mountains_shapefile/Koolaus.shp"
#writeVector(selected_polygons, shapefile_path, overwrite=TRUE)
```

### Base Shapefile
```{r}
#shapefile
hawaii_shp <- vect(x = "Data/HI_shapefile/HI.shp") %>% st_as_sf()
hawaii_shp <- st_transform(hawaii_shp, crs = project_crs)
hawaii_shp_cast <- st_cast(hawaii_shp, "POLYGON")

koolau_shp <- vect(x = "Data/Mountains_shapefile/Koolaus.shp") %>% st_as_sf()
waianae_shp <- vect(x = "Data/Mountains_shapefile/Waianae.shp") %>% st_as_sf()
bigisland_shp <- st_as_sf(hawaii_shp_cast$geometry[1])
lanai_shp <- st_as_sf(hawaii_shp_cast$geometry[4])
maui_shp <- st_as_sf(hawaii_shp_cast$geometry[8])
molokai_shp <- st_as_sf(hawaii_shp_cast$geometry[11])
kauai_shp <- st_as_sf(hawaii_shp_cast$geometry[23])
oahu_shp <- st_as_sf(hawaii_shp_cast$geometry[28])

#replace this to change shapefile used to compare env variables against - "bigisland", "lanai", "maui", "molokai", "kauai", "oahu", "koolau", "waianae"
chosen_island <- "koolau"
chosen_map <- get(paste(chosen_island, "_shp", sep = ""))

plot(chosen_map)

```

### Get Snail Shapefile
```{r}
majorislands_shp <- rbind(bigisland_shp, lanai_shp, maui_shp, molokai_shp, kauai_shp, oahu_shp)

snail_island_shp <- majorislands_shp[st_intersects(majorislands_shp, snail_data_sf, sparse = FALSE), ]
snail_island_shp <- snail_island_shp[!st_is_empty(snail_island_shp), ]
```


### Actual Evapotranspiration (mm)
```{r}
actual_evapotranspiration <- raster("Data/Environmental_data/Actual Evapotranspiration (mm)/AET_mm_month_raster/aet_mm_ann/prj.adf")
#actual_evapotranspiration <- projectRaster(actual_evapotranspiration, crs = project_crs)
actual_evapotranspiration_cut <- mask(actual_evapotranspiration, chosen_map)
actual_evapotranspiration_cut <- crop(actual_evapotranspiration_cut, chosen_map)

actual_evapotranspiration_snails <- mask(actual_evapotranspiration, snail_island_shp)
actual_evapotranspiration_snails <- crop(actual_evapotranspiration_snails, snail_island_shp)

png(filename=paste("Outputs/Env_output_plots/actual_evapotranspiration_", chosen_island, ".png", sep=""))
plot(actual_evapotranspiration_cut)
title("Actual Evapotranspiration (mm)")
dev.off()
```

### Annual Rainfall MM GIS - don't use, use bioclim instead
```{r eval=FALSE}
#annual_rainfall <- vect("Data/Environmental_data/Annual Rainfall MM GIS/Annual_Rainfall_(mm)/Annual_Rainfall_(mm).shp")
#annual_rainfall <- projectRaster(annual_rainfall, crs = project_crs)
#annual_rainfall_cut <- mask(annual_rainfall, chosen_map)
#annual_rainfall_cut <- crop(annual_rainfall, chosen_map)
#plot(annual_rainfall_cut)
#title("Annual Rainfall MM GIS")
```

### Available Soil Moisture
```{r}
available_soil_moisture <- raster("Data/Environmental_data/Available Soil Moisture/SoilMoisture_month_raster/sl_mst_ann/prj.adf")
#available_soil_moisture <- projectRaster(available_soil_moisture, crs = project_crs)
available_soil_moisture_cut <- mask(available_soil_moisture, chosen_map)
available_soil_moisture_cut <- crop(available_soil_moisture_cut, chosen_map)

available_soil_moisture_snails <- mask(available_soil_moisture, snail_island_shp)
available_soil_moisture_snails <- crop(available_soil_moisture_snails, snail_island_shp)

png(filename=paste("Outputs/Env_output_plots/available_soil_moisture_", chosen_island, ".png", sep=""))
plot(available_soil_moisture_cut)
title("Available Soil Moisture")
dev.off()
```

### Bioclim Variables
1	Annual mean temperature
2	Mean diurnal range (Mean of monthly max temperature - min temperature) (how much temperature changes during the day)
3	Isothermality (Mean diurnal range/ temperature annual range) (how predictable are temperature swings)
4	Temperature seasonality (Standard deviation of monthly mean temperature)
5	Max temperature of warmest month
6	Min temperature of coldest month
7	Temperature annual range (Max temperature of warmest month - min temperature of coldest month)
8	Mean temperature of wettest quarter
9	Mean temperature of driest quarter
10	Mean temperature of warmest quarter
11	Mean temperature of coldest quarter
12	Annual precipitation
13	Precipitation of wettest month - don't use
14	Precipitation of driest month - don't use
15	Precipitation seasonality (Coefficient of variation for monthly precipitation)
16	Precipitation of wettest quarter
17	Precipitation of driest quarter
18	Precipitation of warmest quarter
19	Precipitation of coldest quarter
```{r}
bioclim_variables <- stack("Data/Environmental_data/Bioclim Variables/baseline_bioclims.tif")
bioclim_variables_cut <- mask(bioclim_variables, chosen_map)
bioclim_variables_cut <- crop(bioclim_variables, chosen_map)

annual_mean_temperature_cut <- bioclim_variables_cut$baseline_bioclims_1
mean_diurnal_range_cut <- bioclim_variables_cut$baseline_bioclims_2
isothermality_cut <- bioclim_variables_cut$baseline_bioclims_3
temperature_seasonality_cut <- bioclim_variables_cut$baseline_bioclims_4
max_temperature_cut <- bioclim_variables_cut$baseline_bioclims_5
min_temperature_cut <- bioclim_variables_cut$baseline_bioclims_6
annual_temperature_range_cut <- bioclim_variables_cut$baseline_bioclims_7
temperature_wet_cut <- bioclim_variables_cut$baseline_bioclims_8
temperature_dry_cut <- bioclim_variables_cut$baseline_bioclims_9
temperature_warm_cut <- bioclim_variables_cut$baseline_bioclims_10
temperature_cold_cut <- bioclim_variables_cut$baseline_bioclims_11
precipitation_cut <- bioclim_variables_cut$baseline_bioclims_12
precipitation_wet_cut <- bioclim_variables_cut$baseline_bioclims_16
precipitation_dry_cut <- bioclim_variables_cut$baseline_bioclims_17
precipitation_seasonality_cut <- bioclim_variables_cut$baseline_bioclims_15
precipitation_warm_cut <- bioclim_variables_cut$baseline_bioclims_18
precipitation_cold_cut <- bioclim_variables_cut$baseline_bioclims_19

bioclim_variables_snails <- mask(bioclim_variables, snail_island_shp)
bioclim_variables_snails <- crop(bioclim_variables_snails, snail_island_shp)

annual_mean_temperature_snails <- bioclim_variables_snails$baseline_bioclims_1
mean_diurnal_range_snails <- bioclim_variables_snails$baseline_bioclims_2
isothermality_snails <- bioclim_variables_snails$baseline_bioclims_3
temperature_seasonality_snails <- bioclim_variables_snails$baseline_bioclims_4
max_temperature_snails <- bioclim_variables_snails$baseline_bioclims_5
min_temperature_snails <- bioclim_variables_snails$baseline_bioclims_6
annual_temperature_range_snails <- bioclim_variables_snails$baseline_bioclims_7
temperature_wet_snails <- bioclim_variables_snails$baseline_bioclims_8
temperature_dry_snails <- bioclim_variables_snails$baseline_bioclims_9
temperature_warm_snails <- bioclim_variables_snails$baseline_bioclims_10
temperature_cold_snails <- bioclim_variables_snails$baseline_bioclims_11
precipitation_snails <- bioclim_variables_snails$baseline_bioclims_12
precipitation_wet_snails <- bioclim_variables_snails$baseline_bioclims_16
precipitation_dry_snails <- bioclim_variables_snails$baseline_bioclims_17
precipitation_seasonality_snails <- bioclim_variables_snails$baseline_bioclims_15
precipitation_warm_snails <- bioclim_variables_snails$baseline_bioclims_18
precipitation_cold_snails <- bioclim_variables_snails$baseline_bioclims_19

png(filename=paste("Outputs/Env_output_plots/annual_mean_temperature_", chosen_island, ".png", sep=""))
plot(annual_mean_temperature_cut)
title("Annual Mean Temperature")
dev.off()

png(filename=paste("Outputs/Env_output_plots/mean_diurnal_range_", chosen_island, ".png", sep=""))
plot(mean_diurnal_range_cut)
title("Mean Diurnal Range")
dev.off()

png(filename=paste("Outputs/Env_output_plots/isothermality_", chosen_island, ".png", sep=""))
plot(isothermality_cut)
title("Isothermality")
dev.off()

png(filename=paste("Outputs/Env_output_plots/temperature_seasonality_", chosen_island, ".png", sep=""))
plot(temperature_seasonality_cut)
title("Temperature Seasonality")
dev.off()

png(filename=paste("Outputs/Env_output_plots/max_temperature_", chosen_island, ".png", sep=""))
plot(max_temperature_cut)
title("Max Temperature")
dev.off()

png(filename=paste("Outputs/Env_output_plots/min_temperature_", chosen_island, ".png", sep=""))
plot(min_temperature_cut)
title("Minimum Temperature")
dev.off()

png(filename=paste("Outputs/Env_output_plots/annual_temperature_range_", chosen_island, ".png", sep=""))
plot(annual_temperature_range_cut)
title("Annual Temperature Range")
dev.off()

png(filename=paste("Outputs/Env_output_plots/temperature_wet_", chosen_island, ".png", sep=""))
plot(temperature_wet_cut)
title("Mean Temperature of Wettest Quarter")
dev.off()

png(filename=paste("Outputs/Env_output_plots/temperature_dry_", chosen_island, ".png", sep=""))
plot(temperature_dry_cut)
title("Mean Temperature of Driest Quarter")
dev.off()

png(filename=paste("Outputs/Env_output_plots/temperature_warm_", chosen_island, ".png", sep=""))
plot(temperature_warm_cut)
title("Mean Temperature of Warmest Quarter")
dev.off()

png(filename=paste("Outputs/Env_output_plots/temperature_cold_", chosen_island, ".png", sep=""))
plot(temperature_cold_cut)
title("Mean Temperature of Coldest Quarter")
dev.off()

png(filename=paste("Outputs/Env_output_plots/precipitation_", chosen_island, ".png", sep=""))
plot(precipitation_cut)
title("Annual Precipitation")
dev.off()

png(filename=paste("Outputs/Env_output_plots/precipitation_wet_", chosen_island, ".png", sep=""))
plot(precipitation_wet_cut)
title("Precipitation of Wettest Quarter")
dev.off()

png(filename=paste("Outputs/Env_output_plots/precipitation_dry_", chosen_island, ".png", sep=""))
plot(precipitation_dry_cut)
title("Precipitation of Driest Quarter")
dev.off()

png(filename=paste("Outputs/Env_output_plots/precipitation_seasonality_", chosen_island, ".png", sep=""))
plot(precipitation_seasonality_cut)
title("Precipitation Seasonality")
dev.off()

png(filename=paste("Outputs/Env_output_plots/precipitation_warm_", chosen_island, ".png", sep=""))
plot(precipitation_warm_cut)
title("Precipitation of Warmest Quarter")
dev.off()

png(filename=paste("Outputs/Env_output_plots/precipitation_cold_", chosen_island, ".png", sep=""))
plot(precipitation_cold_cut)
title("Precipitation of Coldest Quarter")
dev.off()

```

### Canopy Wetness Fraction
```{r}
canopy_wetness_fraction <- raster("Data/Environmental_data/Canopy Wetness Fraction/FractionalCanopyWetness_month_raster/fr_c_w_ann/prj.adf")

canopy_wetness_fraction_cut <- mask(canopy_wetness_fraction, chosen_map)
canopy_wetness_fraction_cut <- crop(canopy_wetness_fraction_cut, chosen_map)

canopy_wetness_fraction_snails <- mask(canopy_wetness_fraction, snail_island_shp)
canopy_wetness_fraction_snails <- crop(canopy_wetness_fraction_snails, snail_island_shp)

png(filename=paste("Outputs/Env_output_plots/canopy_wetness_fraction_", chosen_island, ".png", sep=""))
plot(canopy_wetness_fraction_cut)
title("Canopy Wetness Fraction")
dev.off()
```

### Cloud Frequency
```{r}
cloud_frequency <- raster("Data/Environmental_data/Cloud Frequency/CloudFreq_month_raster/cl_frq_ann/prj.adf")
#cloud_frequency <- projectRaster(cloud_frequency, crs = project_crs)
cloud_frequency_cut <- mask(cloud_frequency, chosen_map)
cloud_frequency_cut <- crop(cloud_frequency_cut, chosen_map)

cloud_frequency_snails <- mask(cloud_frequency, snail_island_shp)
cloud_frequency_snails <- crop(cloud_frequency_snails, snail_island_shp)

png(filename=paste("Outputs/Env_output_plots/cloud_frequency_", chosen_island, ".png", sep=""))
plot(cloud_frequency_cut)
title("Cloud Frequency")
dev.off()
```

### Cloud Free Satellite - don't use
```{r eval=FALSE}
```

### Elevation
```{r}
if (!file.exists(paste("Data/Environmental_data/Elevation/Tif/LH20_Elev_220.Rdata", sep=""))){
  elevation <- raster("Data/Environmental_data/Elevation/Tif/LH20_Elev_220.tif")
  #this takes a while to run
  elevation <- projectRaster(elevation, crs=project_crs)
  save(elevation, file = paste("Data/Environmental_data/Elevation/Tif/LH20_Elev_220.Rdata", sep=""))
  
  elevation_cut <- mask(elevation, chosen_map)
  elevation_cut <- crop(elevation_cut, chosen_map)
  
  elevation_snails <- mask(elevation, snail_island_shp)
  elevation_snails <- crop(elevation_snails, snail_island_shp)
  
  rm(elevation)
  gc()
} else {
  load(paste("Data/Environmental_data/Elevation/Tif/LH20_Elev_220.Rdata", sep=""))
  elevation_cut <- mask(elevation, chosen_map)
  elevation_cut <- crop(elevation_cut, chosen_map)
  
  elevation_snails <- mask(elevation, snail_island_shp)
  elevation_snails <- crop(elevation_snails, snail_island_shp)
  
  rm(elevation)
  gc()
}

png(filename=paste("Outputs/Env_output_plots/elevation_", chosen_island,".png", sep=""))
plot(elevation_cut)
title("Elevation")
dev.off()
```

### Existing Vegetation Cover 2022
```{r}
if (!file.exists(paste("Data/Environmental_data/Existing Vegetation Cover 2022/Tif/LH22_EVC_220.Rdata", sep=""))){
  existing_vegetation_cover <- raster("Data/Environmental_data/Existing Vegetation Cover 2022/Tif/LH22_EVC_220.tif")
  existing_vegetation_cover <- projectRaster(existing_vegetation_cover, crs=project_crs)
  save(existing_vegetation_cover, file = paste("Data/Environmental_data/Existing Vegetation Cover 2022/Tif/LH22_EVC_220.Rdata", sep=""))
  
  existing_vegetation_cover_cut <- mask(existing_vegetation_cover, chosen_map)
  existing_vegetation_cover_cut <- crop(existing_vegetation_cover_cut, chosen_map)
  
  existing_vegetation_cover_snails <- mask(existing_vegetation_cover, snail_island_shp)
  existing_vegetation_cover_snails <- crop(existing_vegetation_cover_snails, snail_island_shp)

  rm(existing_vegetation_cover)
  gc()
} else {
  load(paste("Data/Environmental_data/Existing Vegetation Cover 2022/Tif/LH22_EVC_220.Rdata", sep=""))
  
  existing_vegetation_cover_cut <- mask(existing_vegetation_cover, chosen_map)
  existing_vegetation_cover_cut <- crop(existing_vegetation_cover_cut, chosen_map)
  
  existing_vegetation_cover_snails <- mask(existing_vegetation_cover, snail_island_shp)
  existing_vegetation_cover_snails <- crop(existing_vegetation_cover_snails, snail_island_shp)
  
  rm(existing_vegetation_cover)
  gc()
}

png(filename=paste("Outputs/Env_output_plots/existing_vegetation_cover_", chosen_island, ".png", sep=""))
plot(existing_vegetation_cover_cut)
title("Existing Vegetation Cover")
dev.off()
```

### Existing Vegetation Height 2022
```{r}
if (!file.exists(paste("Data/Environmental_data/Existing Vegetation Height 2022/Tif/LH22_EVH_220.Rdata", sep=""))){
  existing_vegetation_height <- raster("Data/Environmental_data/Existing Vegetation Height 2022/Tif/LH22_EVH_220.tif")
  existing_vegetation_height <- projectRaster(existing_vegetation_height, crs=project_crs)
  save(existing_vegetation_height, file = paste("Data/Environmental_data/Existing Vegetation Height 2022/Tif/LH22_EVH_220.Rdata", sep=""))
  
  existing_vegetation_height_cut <- crop(existing_vegetation_height, chosen_map)
  existing_vegetation_height_cut <- mask(existing_vegetation_height_cut, chosen_map)

  existing_vegetation_height_snails <- crop(existing_vegetation_height, snail_island_shp)
  existing_vegetation_height_snails <- mask(existing_vegetation_height_snails, snail_island_shp)  

  rm(existing_vegetation_height)
  gc()
} else {
  load(paste("Data/Environmental_data/Existing Vegetation Height 2022/Tif/LH22_EVH_220.Rdata", sep=""))
  
  existing_vegetation_height_cut <- crop(existing_vegetation_height, chosen_map)
  existing_vegetation_height_cut <- mask(existing_vegetation_height_cut, chosen_map)

  existing_vegetation_height_snails <- crop(existing_vegetation_height, snail_island_shp)
  existing_vegetation_height_snails <- mask(existing_vegetation_height_snails, snail_island_shp)  

  rm(existing_vegetation_height)
  gc()
}

png(filename=paste("Outputs/Env_output_plots/existing_vegetation_height_", chosen_island, ".png", sep=""))
plot(existing_vegetation_height_cut)
title("Existing Vegetation Height")
dev.off()
```

### Existing Vegetation Type 2022
```{r}
#Existing Vegetation Type 2022
if (!file.exists(paste("Data/Environmental_data/Existing Vegetation Type/Tif/LH20_EVT_220.Rdata", sep=""))){
  existing_vegetation_type <- raster("Data/Environmental_data/Existing Vegetation Type/Tif/LH20_EVT_220.tif")
  existing_vegetation_type <- projectRaster(existing_vegetation_type, crs=project_crs)
  save(existing_vegetation_type, file = paste("Data/Environmental_data/Existing Vegetation Type/Tif/LH20_EVT_220.Rdata", sep=""))
  
  existing_vegetation_type_cut <- crop(existing_vegetation_type, chosen_map)
  existing_vegetation_type_cut <- mask(existing_vegetation_type_cut, chosen_map)
  
  existing_vegetation_type_snails <- crop(existing_vegetation_type, snail_island_shp)
  existing_vegetation_type_snails <- mask(existing_vegetation_type_snails, snail_island_shp)

  rm(existing_vegetation_type)
  gc()
} else {
  load(paste("Data/Environmental_data/Existing Vegetation Type/Tif/LH20_EVT_220.Rdata", sep=""))
  
  existing_vegetation_type_cut <- crop(existing_vegetation_type, chosen_map)
  existing_vegetation_type_cut <- mask(existing_vegetation_type_cut, chosen_map)
  
  existing_vegetation_type_snails <- crop(existing_vegetation_type, snail_island_shp)
  existing_vegetation_type_snails <- mask(existing_vegetation_type_snails, snail_island_shp)

  rm(existing_vegetation_type)
  gc()
}

png(filename=paste("Outputs/Env_output_plots/existing_vegetation_type_", chosen_island, ".png", sep=""))
plot(existing_vegetation_type_cut)
title("Existing Vegetation Type")
dev.off()
```

### Fog Cover
```{r}
fog_cover <- raster("Data/Environmental_data/Fog Cover/MAP_1920_1969_eff_250.tif")
#fog_cover <- projectRaster(fog_cover, crs = project_crs)
fog_cover_cut <- mask(fog_cover, chosen_map)
fog_cover_cut <- crop(fog_cover_cut, chosen_map)

fog_cover_snails <- mask(fog_cover, snail_island_shp)
fog_cover_snails <- crop(fog_cover_snails, snail_island_shp)

png(filename=paste("Outputs/Env_output_plots/fog_cover_", chosen_island,".png", sep=""))
plot(fog_cover_cut)
title("Fog Cover")
dev.off()
```

### Forest Canopy Base Height 2022
```{r}
if (!file.exists(paste("Data/Environmental_data/Forest Canopy Base Height 2022/Tif/LH22_CBH_220.Rdata", sep=""))){
  forest_canopy_base_height <- raster("Data/Environmental_data/Forest Canopy Base Height 2022/Tif/LH22_CBH_220.tif")
  forest_canopy_base_height <- projectRaster(forest_canopy_base_height, crs=project_crs)
  save(forest_canopy_base_height, file = paste("Data/Environmental_data/Forest Canopy Base Height 2022/Tif/LH22_CBH_220.Rdata", sep=""))
  
  forest_canopy_base_height_cut <- crop(forest_canopy_base_height, chosen_map)
  forest_canopy_base_height_cut <- mask(forest_canopy_base_height_cut, chosen_map)

  forest_canopy_base_height_snails <- crop(forest_canopy_base_height, snail_island_shp)
  forest_canopy_base_height_snails <- mask(forest_canopy_base_height_snails, snail_island_shp)
  
  rm(forest_canopy_base_height)
  gc()
} else {
  load(paste("Data/Environmental_data/Forest Canopy Base Height 2022/Tif/LH22_CBH_220.Rdata", sep=""))
  
  forest_canopy_base_height_cut <- crop(forest_canopy_base_height, chosen_map)
  forest_canopy_base_height_cut <- mask(forest_canopy_base_height_cut, chosen_map)

  forest_canopy_base_height_snails <- crop(forest_canopy_base_height, snail_island_shp)
  forest_canopy_base_height_snails <- mask(forest_canopy_base_height_snails, snail_island_shp)
  
  rm(forest_canopy_base_height)
  gc()
}

png(filename=paste("Outputs/Env_output_plots/forest_canopy_base_height_", chosen_island, ".png", sep=""))
plot(forest_canopy_base_height_cut)
title("Forest Canopy Base Height")
dev.off()
```

### Forest Canopy Bulk Density 2022
```{r}
if (!file.exists(paste("Data/Environmental_data/Forest Canopy Bulk Density 2022/Tif/LH22_CBD_220.Rdata", sep=""))){
  forest_canopy_bulk_density <- raster("Data/Environmental_data/Forest Canopy Bulk Density 2022/Tif/LH22_CBD_220.tif")
  forest_canopy_bulk_density <- projectRaster(forest_canopy_bulk_density, crs=project_crs)
  save(forest_canopy_bulk_density, file = paste("Data/Environmental_data/Forest Canopy Bulk Density 2022/Tif/LH22_CBD_220.Rdata", sep=""))
  
  forest_canopy_bulk_density_cut <- crop(forest_canopy_bulk_density, chosen_map)
  forest_canopy_bulk_density_cut <- mask(forest_canopy_bulk_density_cut, chosen_map)

  forest_canopy_bulk_density_snails <- crop(forest_canopy_bulk_density, snail_island_shp)
  forest_canopy_bulk_density_snails <- mask(forest_canopy_bulk_density_snails, snail_island_shp)  
  
  rm(forest_canopy_bulk_density)
  gc()
} else {
  load(paste("Data/Environmental_data/Forest Canopy Bulk Density 2022/Tif/LH22_CBD_220.Rdata", sep=""))
  
  forest_canopy_bulk_density_cut <- crop(forest_canopy_bulk_density, chosen_map)
  forest_canopy_bulk_density_cut <- mask(forest_canopy_bulk_density_cut, chosen_map)

  forest_canopy_bulk_density_snails <- crop(forest_canopy_bulk_density, snail_island_shp)
  forest_canopy_bulk_density_snails <- mask(forest_canopy_bulk_density_snails, snail_island_shp)  
  
  rm(forest_canopy_bulk_density)
  gc()
}

png(filename=paste("Outputs/Env_output_plots/forest_canopy_bulk_density_", chosen_island, ".png", sep=""))
plot(forest_canopy_bulk_density_cut)
title("Forest Canopy Bulk Density")
dev.off()
```

### Forest Canopy Cover 2022
```{r}
if (!file.exists(paste("Data/Environmental_data/Forest Canopy Cover 2022/Tif/LH22_CC_220.Rdata", sep=""))){
  forest_canopy_cover <- raster("Data/Environmental_data/Forest Canopy Cover 2022/Tif/LH22_CC_220.tif")
  forest_canopy_cover <- projectRaster(forest_canopy_cover, crs=project_crs)
  save(forest_canopy_cover, file = paste("Data/Environmental_data/Forest Canopy Cover 2022/Tif/LH22_CC_220.Rdata", sep=""))
  
  forest_canopy_cover_cut <- crop(forest_canopy_cover, chosen_map)
  forest_canopy_cover_cut <- mask(forest_canopy_cover_cut, chosen_map)
  
  forest_canopy_cover_snails <- crop(forest_canopy_cover, snail_island_shp)
  forest_canopy_cover_snails <- mask(forest_canopy_cover_snails, snail_island_shp)

  rm(forest_canopy_cover)
  gc()
} else {
  load(paste("Data/Environmental_data/Forest Canopy Cover 2022/Tif/LH22_CC_220.Rdata", sep=""))
  
  forest_canopy_cover_cut <- crop(forest_canopy_cover, chosen_map)
  forest_canopy_cover_cut <- mask(forest_canopy_cover_cut, chosen_map)
  
  forest_canopy_cover_snails <- crop(forest_canopy_cover, snail_island_shp)
  forest_canopy_cover_snails <- mask(forest_canopy_cover_snails, snail_island_shp)

  rm(forest_canopy_cover)
  gc()
}

png(filename=paste("Outputs/Env_output_plots/forest_canopy_cover_", chosen_island,".png", sep=""))
plot(forest_canopy_cover_cut)
title("Forest Canopy Cover")
dev.off()
```

### Forest Canopy Height 2022
```{r}
if (!file.exists(paste("Data/Environmental_data/Forest Canopy Height 2022/Tif/LH22_CH_220.Rdata", sep=""))){
  forest_canopy_height <- raster("Data/Environmental_data/Forest Canopy Height 2022/Tif/LH22_CH_220.tif")
  forest_canopy_height <- projectRaster(forest_canopy_height, crs=project_crs)
  save(forest_canopy_height, file = paste("Data/Environmental_data/Forest Canopy Height 2022/Tif/LH22_CH_220.Rdata", sep=""))
  
  forest_canopy_height_cut <- crop(forest_canopy_height, chosen_map)
  forest_canopy_height_cut <- mask(forest_canopy_height_cut, chosen_map)
  
  forest_canopy_height_snails <- crop(forest_canopy_height, snail_island_shp)
  forest_canopy_height_snails <- mask(forest_canopy_height_snails, snail_island_shp)

  rm(forest_canopy_height)
  gc()
} else {
  load(paste("Data/Environmental_data/Forest Canopy Height 2022/Tif/LH22_CH_220.Rdata", sep=""))
  
  forest_canopy_height_cut <- crop(forest_canopy_height, chosen_map)
  forest_canopy_height_cut <- mask(forest_canopy_height_cut, chosen_map)
  
  forest_canopy_height_snails <- crop(forest_canopy_height, snail_island_shp)
  forest_canopy_height_snails <- mask(forest_canopy_height_snails, snail_island_shp)

  rm(forest_canopy_height)
  gc()
}

png(filename=paste("Outputs/Env_output_plots/forest_canopy_height_", chosen_island, ".png", sep=""))
plot(forest_canopy_height_cut)
title("Forest Canopy Height")
dev.off()
```

### Forest Height 2013
```{r eval=FALSE}
#forest_height <- raster("Data/Environmental_data/Forest_Height_2013/Oahu_ForestHt_2013.tif")

#if (!file.exists("Data/Environmental_data/Forest_Height_2013/Oahu_ForestHt_2013.Rdata")){
#  forest_height <- raster("Data/Environmental_data/Forest_Height_2013/Oahu_ForestHt_2013.tif")
#  forest_height_oahu <- crop(forest_height, chosen_map_utm4N)
#  forest_height_oahu <- mask(forest_height_oahu, chosen_map_utm4N)
#  forest_height_oahu <- projectRaster(forest_height_oahu, crs = project_crs)
#  save(forest_height_oahu, file = "Data/Environmental_data/Forest_Height_2013/Oahu_ForestHt_2013.Rdata")
#  rm(forest_height)
#  gc()
#} else {
#  load("Data/Environmental_data/Forest_Height_2013/Oahu_ForestHt_2013.Rdata")
#}

#png(filename="Outputs/Env_output_plots/forest_height_oahu.png")
#plot(forest_height_oahu)
#title("Forest Height")
#dev.off()
```

### Leaf Area Index
```{r}
leaf_area_index <- raster("Data/Environmental_data/Leaf Area Index/LAI_month_raster/lai_ann/prj.adf")
#leaf_area_index <- projectRaster(leaf_area_index, crs = project_crs)
leaf_area_index_cut <- mask(leaf_area_index, chosen_map)
leaf_area_index_cut <- crop(leaf_area_index_cut, chosen_map)

leaf_area_index_snails <- mask(leaf_area_index, snail_island_shp)
leaf_area_index_snails <- crop(leaf_area_index_snails, snail_island_shp)

png(filename=paste("Outputs/Env_output_plots/leaf_area_index_", chosen_island, ".png"))
plot(leaf_area_index_cut)
title("Leaf Area Index")
dev.off()
```

### Relative Humidity
```{r}
relative_humidity <- raster("Data/Environmental_data/Relative Humidity/RH_month_raster/rh_ann/prj.adf")
#relative_humidity <- projectRaster(relative_humidity, crs = project_crs)
relative_humidity_cut <- mask(relative_humidity, chosen_map)
relative_humidity_cut <- crop(relative_humidity_cut, chosen_map)

relative_humidity_snails <- mask(relative_humidity, snail_island_shp)
relative_humidity_snails <- crop(relative_humidity_snails, snail_island_shp)

png(filename=paste("Outputs/Env_output_plots/relative_humidity_", chosen_island, ".png", sep=""))
plot(relative_humidity_cut)
title("Relative Humidity")
dev.off()
```

### Slope Degrees
```{r}
if (!file.exists(paste("Data/Environmental_data/Slope Degrees/Tif/LH20_SlpD_220.Rdata", sep=""))){
  slope_degrees <- raster("Data/Environmental_data/Slope Degrees/Tif/LH20_SlpD_220.tif")
  slope_degrees <- projectRaster(slope_degrees, crs=project_crs)
  save(slope_degrees, file = paste("Data/Environmental_data/Slope Degrees/Tif/LH20_SlpD_220.Rdata", sep=""))
  
  slope_degrees_cut <- crop(slope_degrees, chosen_map)
  slope_degrees_cut <- mask(slope_degrees_cut, chosen_map)
  
  slope_degrees_snails <- crop(slope_degrees, snail_island_shp)
  slope_degrees_snails <- mask(slope_degrees_snails, snail_island_shp)

  rm(slope_degrees)
  gc()
} else {
  load(paste("Data/Environmental_data/Slope Degrees/Tif/LH20_SlpD_220.Rdata", sep=""))

  slope_degrees_cut <- crop(slope_degrees, chosen_map)
  slope_degrees_cut <- mask(slope_degrees_cut, chosen_map)
  
  slope_degrees_snails <- crop(slope_degrees, snail_island_shp)
  slope_degrees_snails <- mask(slope_degrees_snails, snail_island_shp)

  rm(slope_degrees)
  gc()
}

png(filename=paste("Outputs/Env_output_plots/slope_degrees_", chosen_island, ".png", sep=""))
plot(slope_degrees_cut)
title("Slope Degrees")
dev.off()
```

### Slope Percent Rise
```{r}
if (!file.exists(paste("Data/Environmental_data/Slope Percent Rise/Tif/LH20_SlpP_220.Rdata", sep=""))){
  slope_percent_rise <- raster("Data/Environmental_data/Slope Percent Rise/Tif/LH20_SlpP_220.tif")
  slope_percent_rise <- projectRaster(slope_percent_rise, crs=project_crs)
  save(slope_percent_rise, file = paste("Data/Environmental_data/Slope Percent Rise/Tif/LH20_SlpP_220.Rdata", sep=""))
  
  slope_percent_rise_cut <- crop(slope_percent_rise, chosen_map)
  slope_percent_rise_cut <- mask(slope_percent_rise_cut, chosen_map)
  
  slope_percent_rise_snails <- crop(slope_percent_rise, snail_island_shp)
  slope_percent_rise_snails <- mask(slope_percent_rise_snails, snail_island_shp)

  rm(slope_percent_rise)
  gc()
} else {
  load(paste("Data/Environmental_data/Slope Percent Rise/Tif/LH20_SlpP_220.Rdata", sep=""))
  
  slope_percent_rise_cut <- crop(slope_percent_rise, chosen_map)
  slope_percent_rise_cut <- mask(slope_percent_rise_cut, chosen_map)
  
  slope_percent_rise_snails <- crop(slope_percent_rise, snail_island_shp)
  slope_percent_rise_snails <- mask(slope_percent_rise_snails, snail_island_shp)

  rm(slope_percent_rise)
  gc()
}

png(filename=paste("Outputs/Env_output_plots/slope_percent_rise_", chosen_island, ".png", sep=""))
plot(slope_percent_rise_cut)
title("Slope Percent Rise")
dev.off()
```

### SO2 - Active - don't use, these are measures of so2 at various points, not a map
```{r eval=FALSE}
```

### Soil Evaporation
```{r}
soil_evaporation <- raster("Data/Environmental_data/Soil Evaporation/mm/SoilEvaporation_mm_month_raster/soil_evaporation_mm_month_raster/se_mm_ann/prj.adf")
#soil_evaporation <- projectRaster(soil_evaporation, crs = project_crs)
soil_evaporation_cut <- mask(soil_evaporation, chosen_map)
soil_evaporation_cut <- crop(soil_evaporation_cut, chosen_map)

soil_evaporation_snails <- mask(soil_evaporation, snail_island_shp)
soil_evaporation_snails <- crop(soil_evaporation_snails, snail_island_shp)

png(filename=paste("Outputs/Env_output_plots/soil_evaporation_", chosen_island, ".png", sep=""))
plot(soil_evaporation_cut)
title("Soil Evaporation")
dev.off()
```

### Soil Fertility Class
```{r}
if (!file.exists(paste("Data/Environmental_data/Soil Fertility Class/FertilityClass_State_wgs84.shp", sep=""))){
  soil_fertility_class <- vect("Data/Environmental_data/Soil Fertility Class/FertilityClass_State.shp")
  soil_fertility_class <- project(soil_fertility_class, project_crs)
  writeVector(soil_fertility_class, paste("Data/Environmental_data/Soil Fertility Class/FertilityClass_State_wgs84.shp", sep=""), filetype="ESRI Shapefile")

  soil_fertility_class_cut <- crop(soil_fertility_class, chosen_map)
  
  soil_fertility_class_snails <- crop(soil_fertility_class, snail_island_shp)

  rm(soil_fertility_class)
  gc()
} else {
  soil_fertility_class <- vect(paste("Data/Environmental_data/Soil Fertility Class/FertilityClass_State_wgs84.shp", sep=""))
  
  soil_fertility_class_cut <- crop(soil_fertility_class, chosen_map)
  
  soil_fertility_class_snails <- crop(soil_fertility_class, snail_island_shp)
  
  rm(soil_fertility_class)
  gc()
}

ncols <- length(unique(soil_fertility_class_cut$FertClass))
cols=sample(col_vector_random, ncols)
soil_colors <- cols[as.factor(soil_fertility_class_cut$FertClass)]

png(filename=paste("Outputs/Env_output_plots/soil_fertility_class_", chosen_island, ".png", sep=""))
plot(soil_fertility_class_cut, col=soil_colors, border=NA)
title("Soil Fertility Class")
legend("bottomright",   # location of legend
      legend=unique(soil_fertility_class_cut$FertClass),
      fill=cols)
dev.off()
```

### Soil Nutrient Holding Capacity
```{r}
if (!file.exists(paste("Data/Environmental_data/Soil Nutrient Holding Capacity/CEC_State_wgs84.shp", sep=""))){
  soil_nutrient_holding_capacity <- vect("Data/Environmental_data/Soil Nutrient Holding Capacity/CEC_State.shp")
  soil_nutrient_holding_capacity <- project(soil_nutrient_holding_capacity, project_crs)
  writeVector(soil_nutrient_holding_capacity, paste("Data/Environmental_data/Soil Nutrient Holding Capacity/CEC_State_wgs84.shp", sep=""), filetype="ESRI Shapefile")

  soil_nutrient_holding_capacity_cut <- crop(soil_nutrient_holding_capacity, chosen_map)

  soil_nutrient_holding_capacity_snails <- crop(soil_nutrient_holding_capacity, snail_island_shp)
  
  rm(soil_nutrient_holding_capacity)
  gc()
} else {
  soil_nutrient_holding_capacity <- vect(paste("Data/Environmental_data/Soil Nutrient Holding Capacity/CEC_State_wgs84.shp", sep=""))
  
  soil_nutrient_holding_capacity_cut <- crop(soil_nutrient_holding_capacity, chosen_map)

  soil_nutrient_holding_capacity_snails <- crop(soil_nutrient_holding_capacity, snail_island_shp)
  
  rm(soil_nutrient_holding_capacity)
  gc()
}
ncols <- length(unique(soil_nutrient_holding_capacity_cut$CECmod_rep) - 1)
cols <- col_vector_ordered(ncols)
#change 0 to gray since 0 is N/A
cols <- c("gray", cols)
soil_colors <- cols[as.factor(soil_nutrient_holding_capacity_cut$CECmod_rep)]

png(filename=paste("Outputs/Env_output_plots/soil_nutrient_holding_capacity_", chosen_island, ".png", sep=""))
plot(soil_nutrient_holding_capacity_cut, col=soil_colors, border=NA)
title("Soil Nutrient Holding Capacity")
legend <- c("Not Available", "Low", "Moderate", "High", "Very High")
cols <- col_vector_ordered(length(legend) - 1)
cols <- c("gray", cols)
legend("bottomright",   # location of legend
      legend=legend,
      fill=cols)
dev.off()
```

### Soil Order Series, don't run
# Start large, go more specific if needed
```{r eval=FALSE}
#if (!file.exists(paste("Data/Environmental_data/Soil Order #Series/SoilOrderSeries_State_wgs84_", chosen_island, ".shp", sep=""))){
#  soil_order_series <- vect("Data/Environmental_data/Soil Order #Series/SoilOrderSeries_State.shp")
#  soil_order_series_cut <- crop(soil_order_series, chosen_map_utm4N)
#  soil_order_series_cut <- project(soil_order_series_cut, cloud_frequency_cut)
#  writeVector(soil_order_series_cut, paste("Data/Environmental_data/Soil Order #Series/SoilOrderSeries_State_wgs84_", chosen_island, ".shp", sep=""))
#  rm(soil_order_series)
#  gc()
#} else {
  
#  soil_order_series_cut <- vect(paste("Data/Environmental_data/Soil Order #Series/SoilOrderSeries_State_wgs84_", chosen_island, ".shp", sep=""))
#}
#ncols <- length(unique(soil_order_series_cut$XXX))
#cols=sample(col_vector, ncols)
#soil_colors <- cols[as.factor(soil_order_series_cut$XXX)]

#png(filename=paste("Outputs/Env_output_plots/soil_order_series_", chosen_island, ".png", sep=""))
#plot(soil_order_series_cut, col=soil_colors, border=NA)
#title("Soil Order Series")
#legend("bottomright",   # location of legend
#      legend=unique(soil_order_series_cut$XXX),
#      fill=cols)
#dev.off()
```

### Soil Organic Matter
```{r}
if (!file.exists(paste("Data/Environmental_data/Soil Organic Matter/OrganicMatter_State_wgs84.shp", sep=""))){
  soil_organic_matter <- vect("Data/Environmental_data/Soil Organic Matter/OrganicMatter_State.shp")
  soil_organic_matter <- project(soil_organic_matter, project_crs)
  writeVector(soil_organic_matter, paste("Data/Environmental_data/Soil Organic Matter/OrganicMatter_State_wgs84.shp", sep=""), filetype="ESRI Shapefile")
  
  soil_organic_matter_cut <- crop(soil_organic_matter, chosen_map)
  
  soil_organic_matter_snails <- crop(soil_organic_matter, snail_island_shp)

  rm(soil_organic_matter)
  gc()
} else {
  soil_organic_matter <- vect(paste("Data/Environmental_data/Soil Organic Matter/OrganicMatter_State_wgs84.shp", sep=""))
  
  soil_organic_matter_cut <- crop(soil_organic_matter, chosen_map)
  
  soil_organic_matter_snails <- crop(soil_organic_matter, snail_island_shp)

  rm(soil_organic_matter)
  gc()
}
ncols <- length(unique(soil_organic_matter_cut$OM_rep) - 1)
cols <- col_vector_ordered(ncols)
#change 0 to gray since 0 is N/A
cols <- c("gray", cols)
soil_colors <- cols[as.factor(soil_organic_matter_cut$OM_rep)]

png(filename=paste("Outputs/Env_output_plots/soil_organic_matter_", chosen_island, ".png", sep=""))
plot(soil_organic_matter_cut, col=soil_colors, border=NA)
title("Soil Organic Matter")
legend <- c("Not Available", "Low", "Moderate", "High", "Very High")
cols <- col_vector_ordered(length(legend) - 1)
cols <- c("gray", cols)
legend("bottomright",   # location of legend
      legend=legend,
      fill=cols)
dev.off()
```

### Soil pH
```{r}
if (!file.exists(paste("Data/Environmental_data/Soil pH/pH_State_wgs84.shp", sep=""))){
  soil_ph <- vect("Data/Environmental_data/Soil pH/pH_State.shp")
  soil_ph <- project(soil_ph, project_crs)
  writeVector(soil_ph, paste("Data/Environmental_data/Soil pH/pH_State_wgs84.shp", sep=""), filetype="ESRI Shapefile")
  
  soil_ph_cut <- crop(soil_ph, chosen_map)
  
  soil_ph_snails <- crop(soil_ph, snail_island_shp)

  rm(soil_ph)
  gc()
} else {
  soil_ph <- vect(paste("Data/Environmental_data/Soil pH/pH_State_wgs84.shp", sep=""))
  
  soil_ph_cut <- crop(soil_ph, chosen_map)
  
  soil_ph_snails <- crop(soil_ph, snail_island_shp)

  rm(soil_ph)
  gc()
}
ncols <- length(unique(soil_ph_cut$pHmod_rep) - 1)
cols <- col_vector_ordered(ncols)
#change 0 to gray since 0 is N/A
cols <- c("gray", cols)
soil_colors <- cols[as.factor(soil_ph_cut$pHmod_rep)]

png(filename=paste("Outputs/Env_output_plots/soil_ph_", chosen_island, ".png", sep=""))
plot(soil_ph_cut, col=soil_colors, border=NA)
title("Soil pH")
legend <- c("Not Available", "Acidic", "Slightly Acidic to Neutral", "Slightly Alkaline to Alkaline")
cols <- col_vector_ordered(length(legend) - 1)
cols <- c("gray", cols)
legend("bottomright",   # location of legend
      legend=legend,
      fill=cols)
dev.off()
```

### Soil Shrink and Swell
```{r}
if (!file.exists(paste("Data/Environmental_data/Soil Shrink and Swell/ShrinkSwell_State_wgs84.shp", sep=""))){
  soil_shrink_and_swell <- vect("Data/Environmental_data/Soil Shrink and Swell/ShrinkSwell_State.shp")
  soil_shrink_and_swell <- project(soil_shrink_and_swell, project_crs)
  writeVector(soil_shrink_and_swell, paste("Data/Environmental_data/Soil Shrink and Swell/ShrinkSwell_State_wgs84.shp", sep=""), filetype="ESRI Shapefile")
  
  soil_shrink_and_swell_cut <- crop(soil_shrink_and_swell, chosen_map)
  
  soil_shrink_and_swell_snails <- crop(soil_shrink_and_swell, snail_island_shp)

  rm(soil_shrink_and_swell)
  gc()
} else {
  soil_shrink_and_swell <- vect(paste("Data/Environmental_data/Soil Shrink and Swell/ShrinkSwell_State_wgs84.shp", sep=""))
  
  soil_shrink_and_swell_cut <- crop(soil_shrink_and_swell, chosen_map)
  
  soil_shrink_and_swell_snails <- crop(soil_shrink_and_swell, snail_island_shp)

  rm(soil_shrink_and_swell)
  gc()
}
ncols <- length(unique(soil_shrink_and_swell_cut$COLE_rep))
cols <- col_vector_ordered(ncols)
soil_colors <- cols[as.factor(soil_shrink_and_swell_cut$COLE_rep)]

png(filename=paste("Outputs/Env_output_plots/soil_shrink_and_swell_", chosen_island, ".png", sep=""))
plot(soil_shrink_and_swell_cut, col=soil_colors, border=NA)
title("Soil Shrink and Swell")
legend <- c("Low", "Moderate", "High", "Very High")
cols <- col_vector_ordered(length(legend))
legend("bottomright",   # location of legend
      legend=legend,
      fill=cols)
dev.off()
```

### Soil Water Permeablity
```{r}
if (!file.exists(paste("Data/Environmental_data/Soil Water Permeability/WaterPermeability_State_wgs84.shp", sep=""))){
  soil_water_permeability <- vect("Data/Environmental_data/Soil Water Permeability/WaterPermeability_State.shp")
  soil_water_permeability <- project(soil_water_permeability, project_crs)
  writeVector(soil_water_permeability, paste("Data/Environmental_data/Soil Water Permeability/WaterPermeability_State_wgs84.shp", sep=""), filetype="ESRI Shapefile")
  
  soil_water_permeability_cut <- crop(soil_water_permeability, chosen_map)
  
  soil_water_permeability_snails <- crop(soil_water_permeability, snail_island_shp)

  rm(soil_water_permeability)
  gc()
} else {
  soil_water_permeability <- vect(paste("Data/Environmental_data/Soil Water Permeability/WaterPermeability_State_wgs84.shp", sep=""))
  
  soil_water_permeability_cut <- crop(soil_water_permeability, chosen_map)
  
  soil_water_permeability_snails <- crop(soil_water_permeability, snail_island_shp)

  rm(soil_water_permeability)
  gc()
}
ncols <- length(unique(soil_water_permeability_cut$Ksat_rep) - 1)
cols <- col_vector_ordered(ncols)
#change 0 to gray since 0 is N/A
cols <- c("gray", cols)
soil_colors <- cols[as.factor(soil_water_permeability_cut$Ksat_rep)]

png(filename=paste("Outputs/Env_output_plots/soil_water_permeability_", chosen_island, ".png", sep=""))
plot(soil_water_permeability_cut, col=soil_colors, border=NA)
title("Soil Water Permeablity")
legend <- c("Not Available", "Slow", "Moderate", "Fast", "Very Fast")
cols <- col_vector_ordered(length(legend) - 1)
cols <- c("gray", cols)
legend("bottomright",   # location of legend
      legend=legend,
      fill=cols)
dev.off()
```

### TNC Ecosystems Before and Current
```{r}
#BEFORE
if (!file.exists(paste("Data/Environmental_data/TNC Ecosystems Before and Current/Before_Ecosystems_wgs84.shp", sep=""))){
  tnc_before <- vect("Data/Environmental_data/TNC Ecosystems Before and Current/Before_Ecosystems.shp")
  tnc_before <- project(tnc_before, project_crs)
  writeVector(tnc_before, paste("Data/Environmental_data/TNC Ecosystems Before and Current/Before_Ecosystems_wgs84.shp", sep=""), filetype="ESRI Shapefile")
  
  tnc_before_cut <- crop(tnc_before, chosen_map)
  
  tnc_before_snails <- crop(tnc_before, snail_island_shp)

  rm(tnc_before)
  gc()
} else {
  tnc_before <- vect(paste("Data/Environmental_data/TNC Ecosystems Before and Current/Before_Ecosystems_wgs84.shp", sep=""))
  
  tnc_before_cut <- crop(tnc_before, chosen_map)
  
  tnc_before_snails <- crop(tnc_before, snail_island_shp)

  rm(tnc_before)
  gc()
}
tnc_ecosystems <- c("Lowland Dry Forest & Shrubland", "Lowland Dry Shrubland & Grassland", "Lowland Dry Ecosystems", "Lowland Mesic Forest & Shrubland", "Lowland Wet Forest & Shrubland", "Montane Wet Forest & Shrubland", "Wetland", "Dry Cliff", "Wet Cliff", "Non-native", "water")
ncols <- length(tnc_ecosystems)
cols=sample(col_vector_random, ncols)
ecosystems_colors <- cols[factor(tnc_before_cut$COMMUNITY, ordered=TRUE, levels=tnc_ecosystems)]

png(filename=paste("Outputs/Env_output_plots/tnc_before_", chosen_island, ".png", sep=""))
plot(tnc_before_cut, col=ecosystems_colors, border=NA, mar = c(2.1,4.1,4.1,10))
title("TNC Ecosystems Before")
legend("bottomright",   # location of legend
      legend=tnc_ecosystems,
      fill=cols,
      inset=c(-.4, 0),
      xpd=TRUE, 
      cex = 0.7)
dev.off()

#CURRENT
if (!file.exists(paste("Data/Environmental_data/TNC Ecosystems Before and Current/Current_Ecosystems_wgs84.shp", sep=""))){
  tnc_current <- vect("Data/Environmental_data/TNC Ecosystems Before and Current/Current_Ecosystems.shp")
  tnc_current <- project(tnc_current, project_crs)
  writeVector(tnc_current, paste("Data/Environmental_data/TNC Ecosystems Before and Current/Current_Ecosystems_wgs84.shp", sep=""), filetype="ESRI Shapefile")
  
  tnc_current_cut <- crop(tnc_current, chosen_map)
  
  tnc_current_snails <- crop(tnc_current, snail_island_shp)

  rm(tnc_current)
  gc()
} else {
  tnc_current <- vect(paste("Data/Environmental_data/TNC Ecosystems Before and Current/Current_Ecosystems_wgs84.shp", sep=""))
  
  tnc_current_cut <- crop(tnc_current, chosen_map)
  
  tnc_current_snails <- crop(tnc_current, snail_island_shp)

  rm(tnc_current)
  gc()
}

ecosystems_colors <- cols[factor(tnc_current_cut$COMMUNITY, ordered=TRUE, levels=tnc_ecosystems)]

png(filename=paste("Outputs/Env_output_plots/tnc_current_", chosen_island, ".png", sep=""))
plot(tnc_current_cut, col=ecosystems_colors, border=NA, mar = c(2.1,4.1,4.1,10))
title("TNC Ecosystems Current")
legend("bottomright",   # location of legend
      legend=tnc_ecosystems,
      fill=cols,
      inset=c(-.4, 0),
      xpd=TRUE, 
      cex = 0.7)
dev.off()

```

### Wet Canopy Evaporation
```{r}
wet_canopy_evaporation <- raster("Data/Environmental_data/Wet Canopy Evaporation/mm/WetCanopyEvaporation_mm_month_raster/wet_canopy_evaporation_mm_month_raster/wce_mm_ann/prj.adf")
#wet_canopy_evaporation <- projectRaster(wet_canopy_evaporation, crs = project_crs)
wet_canopy_evaporation_cut <- mask(wet_canopy_evaporation, chosen_map)
wet_canopy_evaporation_cut <- crop(wet_canopy_evaporation_cut, chosen_map)

wet_canopy_evaporation_snails <- mask(wet_canopy_evaporation, snail_island_shp)
wet_canopy_evaporation_snails <- crop(wet_canopy_evaporation_snails, snail_island_shp)

png(filename=paste("Outputs/Env_output_plots/wet_canopy_evaporation_", chosen_island, ".png", sep=""))
plot(wet_canopy_evaporation_cut)
title("Wet Canopy Evaporation")
dev.off()
```

### Wind Speed GIS - not sure how to get data from this
```{r}
#wind_speed <- vect("Data/Environmental_data/Wind Speed GIS/30m above ground/Wind_Speed_30m/Wind_Speed_30m.shp")
#wind_speed <- projectRaster(wind_speed, crs = project_crs)
#wind_speed_cut <- terra::intersect(wind_speed, vect(chosen_map))
#wind_speed_cut <- crop(wind_speed_cut, chosen_map)
#ncols <- length(unique(wind_speed_cut$speed_mps))
#cols <- col_vector_ordered(ncols)
#wind_colors <- cols[factor(wind_speed_cut$speed_mps, ordered = TRUE)]

#png(filename=paste("Outputs/Env_output_plots/wind_speed_", chosen_island, ".png", sep=""))
#plot(wind_speed_cut, col=wind_colors)
#lines(chosen_map)
#title("Wind Speed")
#legend("right",   # location of legend
#      legend=sort(unique(wind_speed_cut$speed_mps)),
#      fill=cols,
#      cex=0.6)
#dev.off()
```

# Clean Data

## Snail Data
```{r}
snail_data_sf_filtered <- snail_data_sf %>%
  filter(coordinateUncertaintyInMeters <= 1000) %>%  # Remove points with an uncertainty of higher than a number
  distinct(geometry, .keep_all = TRUE)  # Keep only distinct points based on geometry (lat and long)

#change points to polygons with uncertainty
snail_data_sf_uncertainty <- st_buffer(snail_data_sf_filtered, snail_data_sf_filtered$coordinateUncertaintyInMeters)
```

## Environmental Data
### Base Maps
```{r}
# Create lists of data
env_rasters_qual <- c(actual_evapotranspiration_cut = actual_evapotranspiration_cut, 
                     available_soil_moisture_cut = available_soil_moisture_cut, 
                     annual_mean_temperature_cut = annual_mean_temperature_cut, 
                     mean_diurnal_range_cut = mean_diurnal_range_cut, 
                     isothermality_cut = isothermality_cut, 
                     temperature_seasonality_cut = temperature_seasonality_cut, 
                     max_temperature_cut = max_temperature_cut, 
                     min_temperature_cut = min_temperature_cut, 
                     annual_temperature_range_cut = annual_temperature_range_cut, 
                     temperature_wet_cut = temperature_wet_cut, 
                     temperature_dry_cut = temperature_dry_cut, 
                     temperature_warm_cut = temperature_warm_cut, 
                     temperature_cold_cut = temperature_cold_cut, 
                     precipitation_cut = precipitation_cut, 
                     precipitation_wet_cut = precipitation_wet_cut, 
                     precipitation_dry_cut = precipitation_dry_cut, 
                     precipitation_seasonality_cut = precipitation_seasonality_cut, 
                     precipitation_warm_cut = precipitation_warm_cut, 
                     precipitation_cold_cut = precipitation_cold_cut, 
                     canopy_wetness_fraction_cut = canopy_wetness_fraction_cut,
                     cloud_frequency_cut = cloud_frequency_cut,
                     elevation_cut = elevation_cut,
                     existing_vegetation_cover_cut = existing_vegetation_cover_cut,
                     existing_vegetation_height_cut = existing_vegetation_height_cut,
                     fog_cover_cut = fog_cover_cut,
                     forest_canopy_base_height_cut = forest_canopy_base_height_cut,
                     forest_canopy_bulk_density_cut = forest_canopy_bulk_density_cut,
                     forest_canopy_cover_cut = forest_canopy_cover_cut,
                     forest_canopy_height_cut = forest_canopy_height_cut,
                     leaf_area_index_cut = leaf_area_index_cut,
                     relative_humidity_cut = relative_humidity_cut,
                     slope_degrees_cut = slope_degrees_cut,
                     slope_percent_rise_cut = slope_percent_rise_cut,
                     soil_evaporation_cut = soil_evaporation_cut,
                     wet_canopy_evaporation_cut = wet_canopy_evaporation_cut
                     )
env_rasters_class <- c(existing_vegetation_type_cut = existing_vegetation_type_cut)
env_shapes_qual <- c(soil_nutrient_holding_capacity_cut = soil_nutrient_holding_capacity_cut,
                    soil_organic_matter_cut = soil_organic_matter_cut,
                    soil_ph_cut = soil_ph_cut,
                    soil_shrink_and_swell_cut = soil_shrink_and_swell_cut,
                    soil_water_permeability_cut = soil_water_permeability_cut
                    )
env_shapes_class <- c(soil_fertility_class_cut = soil_fertility_class_cut,
                      tnc_before_cut = tnc_before_cut,
                      tnc_current_cut = tnc_current_cut)

#wind_speed_cut
```

### Snail Occurrence Maps
```{r}
env_rasters_qual_snails <- c(actual_evapotranspiration_snails = actual_evapotranspiration_snails, 
                     available_soil_moisture_snails = available_soil_moisture_snails, 
                     annual_mean_temperature_snails = annual_mean_temperature_snails, 
                     mean_diurnal_range_snails = mean_diurnal_range_snails, 
                     isothermality_snails = isothermality_snails, 
                     temperature_seasonality_snails = temperature_seasonality_snails, 
                     max_temperature_snails = max_temperature_snails, 
                     min_temperature_snails = min_temperature_snails, 
                     annual_temperature_range_snails = annual_temperature_range_snails, 
                     temperature_wet_snails = temperature_wet_snails, 
                     temperature_dry_snails = temperature_dry_snails, 
                     temperature_warm_snails = temperature_warm_snails, 
                     temperature_cold_snails = temperature_cold_snails, 
                     precipitation_snails = precipitation_snails, 
                     precipitation_wet_snails = precipitation_wet_snails, 
                     precipitation_dry_snails = precipitation_dry_snails, 
                     precipitation_seasonality_snails = precipitation_seasonality_snails, 
                     precipitation_warm_snails = precipitation_warm_snails, 
                     precipitation_cold_snails = precipitation_cold_snails, 
                     canopy_wetness_fraction_snails = canopy_wetness_fraction_snails,
                     cloud_frequency_snails = cloud_frequency_snails,
                     elevation_snails = elevation_snails,
                     existing_vegetation_cover_snails = existing_vegetation_cover_snails,
                     existing_vegetation_height_snails = existing_vegetation_height_snails,
                     fog_cover_snails = fog_cover_snails,
                     forest_canopy_base_height_snails = forest_canopy_base_height_snails,
                     forest_canopy_bulk_density_snails = forest_canopy_bulk_density_snails,
                     forest_canopy_cover_snails = forest_canopy_cover_snails,
                     forest_canopy_height_snails = forest_canopy_height_snails,
                     leaf_area_index_snails = leaf_area_index_snails,
                     relative_humidity_snails = relative_humidity_snails,
                     slope_degrees_snails = slope_degrees_snails,
                     slope_percent_rise_snails = slope_percent_rise_snails,
                     soil_evaporation_snails = soil_evaporation_snails,
                     wet_canopy_evaporation_snails = wet_canopy_evaporation_snails
                     )
env_rasters_class_snails <- c(existing_vegetation_type_snails = existing_vegetation_type_snails)
env_shapes_qual_snails <- c(soil_nutrient_holding_capacity_snails = soil_nutrient_holding_capacity_snails,
                    soil_organic_matter_snails = soil_organic_matter_snails,
                    soil_ph_snails = soil_ph_snails,
                    soil_shrink_and_swell_snails = soil_shrink_and_swell_snails,
                    soil_water_permeability_snails = soil_water_permeability_snails
                    )
env_shapes_class_snails <- c(soil_fertility_class_snails = soil_fertility_class_snails,
                      tnc_before_snails = tnc_before_snails,
                      tnc_current_snails = tnc_current_snails)

#wind_speed_snails
```


# Pull Niche Data

## Snails
```{r}
#env_rasters_qual

snail_env_data <- data.frame()
assign("snail_env_data", TRUE, env=globalenv())
tryCatch ({
  env_values <- as.data.frame(lapply(env_rasters_qual_snails, function(raster) {
    extract(raster, snail_data_sf_uncertainty, method = "simple", fun = mean)
  }))
  snail_env_data <- cbind(snail_data_sf_uncertainty, env_values)
}, error = function(e) {
  assign("snail_env_data", snail_data_sf_uncertainty, env=globalenv())
})

#env_rasters_class


#env_shapes_qual
#extract(soil_nutrient_holding_capacity_cut[,11], vect(snail_data_sf_uncertainty))

#env_shapes_class
```

## Exclosures
```{r}
#env_rasters_qual

exclosures_env_data <- data.frame()
assign("exclosures_env_data", TRUE, env=globalenv())
tryCatch ({
  env_values <- as.data.frame(lapply(env_rasters_qual, function(raster) {
    extract(raster, exclosure_data_sf, method = "simple", fun = mean)
  }))
  exclosures_env_data <- cbind(exclosure_data_sf, env_values)
}, error = function(e) {
  assign("exclosures_env_data", exclosure_data_sf, env=globalenv())
})

#env_rasters_class

#env_shapes_qual

#env_shapes_class
```

# Outputs

## 1D Histogram Plots
```{r}
# note this only works when all occurrences are on one island
plots_list <- vector("list", length = length(env_rasters_qual))
group <- toTitleCase(chosen_island)

for (i in seq_along(plots_list)) {

  filename=paste("Outputs/1D_plots/", names(env_rasters_qual[i]), "_", chosen_island, ".jpg", sep="")
  col_name <- names(env_rasters_qual[i])
  all_cut_data <- data.frame(as.data.frame(get(col_name)), group=group)
  
  if(ncol(snail_env_data) > 14){
    micans_data <- data.frame(as.data.frame(snail_env_data[i+13])[,1], group="Amastra micans")
    colnames(micans_data) <- colnames(all_cut_data)
    comb_data <- rbind(all_cut_data, micans_data)
    comb_data <- comb_data[complete.cases(comb_data), ]
    
    plots_list[[i]] <- ggplot(comb_data, aes(x = .data[[colnames(as.data.frame(get(col_name)))]])) +
      geom_histogram(aes(y = ..ncount.., fill=group, color=group), bins = 40, alpha = 0.6, position = "identity") +
      geom_vline(xintercept = as.data.frame(exclosures_env_data[, i+2])[,1],
                 color = "red", linetype = "solid", linewidth = .5) +
      geom_text(data = data.frame(x = as.data.frame(exclosures_env_data[, i+2])[,1], 
                                  label = as.data.frame(exclosures_env_data[, 2])[,1]), 
                aes(x = x, y=0, label = label), vjust = -0.5, hjust = 0, color = "black", angle = 90, size = 3.5) +
      labs(title = paste(names(env_rasters_qual[i]), "_", chosen_island, sep=""),
           x = names(env_rasters_qual[i]),
           y = "Scaled Density") +
      xlim(c(env_rasters_qual[i][[names(env_rasters_qual[i])]]@data@min, env_rasters_qual[i][[names(env_rasters_qual[i])]]@data@max)) +
      theme_minimal()
    
  } else {
    comb_data <- all_cut_data
    comb_data <- comb_data[complete.cases(comb_data), ]
    
    plots_list[[i]] <- ggplot(comb_data, aes(x = .data[[colnames(as.data.frame(get(col_name)))]])) +
      geom_histogram(aes(y = ..ncount..), bins = 40, alpha = 0.6, position = "identity", color="#01bdc3", fill="#66d9dc") +
      labs(title = paste(names(env_rasters_qual[i]), "_", chosen_island, sep=""),
           x = names(env_rasters_qual[i]),
           y = "Scaled Density") +
      xlim(c(env_rasters_qual[i][[names(env_rasters_qual[i])]]@data@min, env_rasters_qual[i][[names(env_rasters_qual[i])]]@data@max)) +
      theme_minimal()
  }
  ggsave(filename, plots_list[[i]], device = "jpg", dpi = 300, width = 3184, height = 1959, units = "px")
}

#plot_grid(plotlist = plots_list[1:8], nrow = 4, align = "h")
#plot_grid(plotlist = plots_list[9:16], nrow = 4, align = "h")
#plot_grid(plotlist = plots_list[17:24], nrow = 4, align = "h")
#plot_grid(plotlist = plots_list[25:32], nrow = 4, align = "h")
#plot_grid(plotlist = plots_list[33:35], nrow = 3, align = "h")

```

## Calculate Exclosure Rankings
```{r}
all_iterations_df <- data.frame(Exclosure = character())
group <- toTitleCase(chosen_island)

for (i in 1:35) {
  filename=paste("Outputs/1D_plots/", colnames(snail_env_data[, 14:49])[i], ".jpg", sep="")
  col_name <- colnames(snail_env_data[, 14:49])[i]
  all_cut_data <- data.frame(as.data.frame(get(col_name)), group=group)
  micans_data <- data.frame(as.data.frame(snail_env_data[i+13])[,1], group="Amastra micans")
  colnames(micans_data) <- colnames(all_cut_data)
  comb_data <- rbind(all_cut_data, micans_data)
  comb_data <- comb_data[complete.cases(comb_data), ]
  
  #rank the exclosures
  cut_numbers <- cut(as.data.frame(exclosures_env_data[, i+2])[,1], breaks = hist(comb_data[[1]], plot = FALSE, breaks = 40)$breaks, include.lowest = TRUE)
  frequency_table <- table(cut(micans_data[[1]], breaks = hist(comb_data[[1]], plot = FALSE, breaks = 40)$breaks, include.lowest = TRUE))
  data_to_rank <- data.frame(Exclosure = as.data.frame(exclosures_env_data[, 1])[,1], Bin = cut_numbers)
  
  ranked_exclosures <- data_to_rank %>%
    left_join(data.frame(Bin = names(frequency_table), Freq = as.numeric(frequency_table)), by = "Bin") %>%
    arrange(desc(Freq), Exclosure) %>%
    select(Exclosure, Freq)
  
  ranked_exclosures <- ranked_exclosures %>%
    mutate(Rank = dense_rank(desc(Freq))) %>%
    select(Exclosure, Rank)
  colnames(ranked_exclosures) <- c("Exclosure", colnames(snail_env_data[, 14:49])[i])
  all_iterations_df <- merge(all_iterations_df, ranked_exclosures, by = "Exclosure", all = TRUE)
}


all_iterations_df$Sum <- rowSums(all_iterations_df[, -1, drop = FALSE])
all_iterations_df$Mean <- rowMeans(all_iterations_df[, -c(1, ncol(all_iterations_df)), drop = FALSE])
all_iterations_df <- all_iterations_df[order(all_iterations_df$Sum, decreasing = FALSE), ]
write.csv(all_iterations_df, file = "Outputs/exclosure_rankings.csv", row.names=FALSE)
```


## 2D Plots
```{r}
#595 combinations so don't loop through them all, just pick two

xenvdata <- "relative_humidity_cut"
yenvdata <- "slope_degrees_cut"

group <- toTitleCase(chosen_island)

filename=paste("Outputs/2D_plots/", xenvdata, "_", yenvdata, ".jpg", sep="")
all_cut_data <- data.frame(as.data.frame(get(xenvdata)), as.data.frame(get(yenvdata)), group=group)
micans_data <- data.frame(as.data.frame(snail_env_data[xenvdata])[,1], as.data.frame(snail_env_data[yenvdata])[,1], group="Amastra micans")
colnames(micans_data) <- colnames(all_cut_data)
comb_data <- rbind(all_cut_data, micans_data)
comb_data <- comb_data[complete.cases(comb_data), ]
exclosure_data <- data.frame(as.data.frame(exclosures_env_data[, xenvdata])[,1], as.data.frame(exclosures_env_data[, yenvdata])[,1], as.data.frame(exclosures_env_data[, 2])[,1])
colnames(exclosure_data) <- c(xenvdata, yenvdata, "Exclosure")

plot <- ggplot(comb_data, aes(x = .data[[colnames(as.data.frame(get(xenvdata)))]],
                              y = .data[[colnames(as.data.frame(get(yenvdata)))]])) +
  geom_point(aes(fill=group, color=group), alpha = 0.5, position = "identity") +
  geom_point(data = exclosure_data, aes(x = .data[[colnames(exclosure_data)[1]]], 
                                        y = .data[[colnames(exclosure_data)[2]]]), color = "red", shape = 17, size = 3) +
  geom_text(data = exclosure_data, aes(x = .data[[colnames(exclosure_data)[1]]], 
                                       y = .data[[colnames(exclosure_data)[2]]], 
                                       label = .data[[colnames(exclosure_data)[3]]]),
            vjust = -.8, hjust = 0, color = "black", size = 3.5) +
  labs(title = paste(xenvdata, "x", yenvdata),
       x = xenvdata,
       y = yenvdata) +
  theme_minimal()
plot
ggsave(filename, plot, device = "jpg")

```

## 3D Plots
```{r}

xenvdata <- "annual_mean_temperature"
yenvdata <- "precipitation"
zenvdata <- "slope_degrees_cut"

group <- toTitleCase(chosen_island)

filename=paste("Outputs/3D_plots/", xenvdata, "_", yenvdata, "_", zenvdata, ".html", sep="")
all_cut_data <- data.frame(as.data.frame(get(xenvdata)), as.data.frame(get(yenvdata)), as.data.frame(get(zenvdata)), group=group)
micans_data <- data.frame(as.data.frame(snail_env_data[xenvdata])[,1], as.data.frame(snail_env_data[yenvdata])[,1], as.data.frame(snail_env_data[zenvdata])[,1], group="Amastra micans")
colnames(micans_data) <- colnames(all_cut_data)
comb_data <- rbind(all_cut_data, micans_data)
comb_data <- comb_data[complete.cases(comb_data), ]
exclosure_data <- data.frame(as.data.frame(exclosures_env_data[, xenvdata])[,1], as.data.frame(exclosures_env_data[, yenvdata])[,1], as.data.frame(exclosures_env_data[, zenvdata])[,1],as.data.frame(exclosures_env_data[, 2])[,1])
colnames(exclosure_data) <- c(xenvdata, yenvdata, zenvdata, "Exclosure")

plot <- plot_ly(comb_data, x = comb_data[[colnames(as.data.frame(get(xenvdata)))]],
                   y = comb_data[[colnames(as.data.frame(get(yenvdata)))]],
                   z = comb_data[[colnames(as.data.frame(get(zenvdata)))]],
                        color = ~group, colors = c("#fbada7", "#66d9dc"), 
                        marker = list(size = 3, opacity = 1),
                        text = ~paste("Group: ", group),
                        type = "scatter3d", mode = "markers") %>% 
        add_trace(x = exclosure_data[[colnames(exclosure_data)[1]]], 
                           y = exclosure_data[[colnames(exclosure_data)[2]]], 
                           z = exclosure_data[[colnames(exclosure_data)[3]]],
                           type = "scatter3d", 
                           mode = "markers+text",
                           inherit=FALSE,
                           marker = list(size = 4, color = "red", symbol = 'diamond'),
                           text = exclosure_data[[colnames(exclosure_data)[4]]]) %>% 
        layout(title = paste(xenvdata, "x", yenvdata, "x", zenvdata),
                         scene = list(xaxis = list(title = xenvdata),
                                      yaxis = list(title = yenvdata),
                                      zaxis = list(title = zenvdata),
                                      camera = list(eye = list(x = 2.2,y = 0, z=0.2),
                                              center = list(x = 0,
                                                            y = 0,
                                                            z = 0
                                                            )))) %>%
  onRender("
      function(el, x){
  var id = el.getAttribute('id');
  var gd = document.getElementById(id);
  Plotly.update(id).then(attach);
  function attach() {
    var cnt = 0;
    
    function run() {
      rotate('scene', Math.PI / 550);
      requestAnimationFrame(run);
    } 
    run();
    
    function rotate(id, angle) {
      var eye0 = gd.layout[id].camera.eye
      var rtz = xyz2rtz(eye0);
      rtz.t += angle;
      
      var eye1 = rtz2xyz(rtz);
      Plotly.relayout(gd, id + '.camera.eye', eye1)
    }
    
    function xyz2rtz(xyz) {
      return {
        r: Math.sqrt(xyz.x * xyz.x + xyz.y * xyz.y),
        t: Math.atan2(xyz.y, xyz.x),
        z: xyz.z
      };
    }
    
    function rtz2xyz(rtz) {
      return {
        x: rtz.r * Math.cos(rtz.t),
        y: rtz.r * Math.sin(rtz.t),
        z: rtz.z
      };
    }
  };
}
    ")
plot
htmlwidgets::saveWidget(as_widget(plot), filename)

```